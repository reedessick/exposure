#!/usr/bin/env python

__usage__ = "compute_horizon [--options] psd.txt.gz"
__description__ = "computes the expected range given the PSD. NOTE: this is only an approximation to the range using a very basic PN expression for a conformal waveform strain in the frequency domain. We may want to improve this by actually calling waveform generators to compute the strain"
__author__ = "Reed Essick (reed.essick@ligo.org)"

#-------------------------------------------------

import os
import gzip

import numpy as np

from optparse import OptionParser

### non-standard libraries
from exposure import utils
from exposure import simulation
from skymap_statistics import detector_cache

#-------------------------------------------------

parser = OptionParser(usage=__usage__, description=__description__)

parser.add_option('-v', '--verbose', default=False, action='store_true')

parser.add_option('', '--flow', default=simulation.DEFAULT_FLOW, type='float',
    help='DEFAULT=%.3f'%simulation.DEFAULT_FLOW)
parser.add_option('', '--fhigh', default=simulation.DEFAULT_FHIGH, type='float',
    help='DEFAULT=%.3f'%simulation.DEFAULT_FHIGH)

parser.add_option('', '--snr-thr', default=simulation.DEFAULT_SNR_THRESHOLD, type='float',
    help='an arbitrary snr threshold defining what is detectable. Used to estimate the horizon')

parser.add_option('-o', '--output-dir', default='.', type='string')
parser.add_option('-t', '--tag', default='', type='string')

opts, args = parser.parse_args()

assert len(args)==1, 'please supply exactly 1 input argument\n%s'%__usage__

if opts.tag:
    opts.tag = "_"+opts.tag

if not os.path.exists(opts.output_dir):
    os.makedirs(opts.output_dir)

gpstart, gpsdur = [int(_) for _ in args[0].strip('.txt.gz').split('-')[-2:]] ### need this to identify time range of data used

#-------------------------------------------------

if opts.verbose:
    print( "reading : "+args[0] )
psd = detector_cache.PSD(*np.loadtxt(args[0]).transpose()) ### freq, psd
detector = detector_cache.Detector('dummy', [0,0,0], [1,0,0], [0,1,0], psd=psd)

### compute the horizon for this detector
horizon = simulation.detector2horizon(detector, opts.snr_thr, flow=opts.flow, fhigh=opts.fhigh)[0][1]

### save
path = utils.horizon_path(opts.output_dir, opts.tag, gpstart, gpsdur)
if opts.verbose:
    print( 'writing : '+path )
utils.report_horizon(path, horizon, opts.flow, opts.fhigh, args[0])

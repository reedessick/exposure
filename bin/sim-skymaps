#!/usr/bin/env python

__usage__ = "sim-skymaps [--options] gps_start gps_stop"
__doc__ = """\
a simple script for generating simulated skymaps using quasi-realistic detectors.
NOTE:
    we ignore the relative sensitivity of detectors, which would affect the time-delay-errors via signal bandwidth and snr, etc. This should be corrected in the future."""
__author__ = "reed.essick@ligo.org"

#-------------------------------------------------

import os

import healpy as hp

from optparse import OptionParser

### non-standard libraries
import simUtils
import detector_cache

#-------------------------------------------------

DEFAULT_COORD = 'C'
KNOWN_COORD = ['C', 'E']

#-------------------------------------------------

parser = OptionParser(usage=__usage__, description=__doc__)

parser.add_option('-v', '--verbose', default=False, action='store_true')
parser.add_option('-V', '--Verbose', default=False, action='store_true')

parser.add_option('-i', '--ifo', default=[], type='string', action='append',
    help='can be repeated')
parser.add_option('-n', '--num-events', default=simUtils.DEFAULT_SIZE, type='int',
    help='DEFAULT=%d'%simUtils.DEFAULT_SIZE)

parser.add_option('--coord', default=DEFAULT_COORD, type='string',
    help='either E or C. DEFAULT='+DEFAULT_COORD)
parser.add_option('--time-delay-error', default=simUtils.DEFAULT_TIME_DELAY_ERROR, type='float',
    help='standard deviation for a Gaussian for time-delay error specified in seconds. \
DEFAULT=%.3e'%simUtils.DEFAULT_TIME_DELAY_ERROR)
parser.add_option('--nside', default=simUtils.DEFAULT_NSIDE, type='int',
    help='DEFAULT=%d'%simUtils.DEFAULT_NSIDE)

parser.add_option('-o', '--output-dir', default='.', type='string')
parser.add_option('-t', '--tag', default='', type='string')

opts, args = parser.parse_args()
assert len(args)==2, 'please supply exactly 2 input arguments\n%s'%__usage__
gps_start, gps_stop = [float(_) for _ in args]
assert opts.coord in KNOWN_COORD, '--coord must be one of: '+','.join(KNOWN_COORD)

if not os.path.exists(opts.output_dir):
    os.makedirs(opts.output_dir)

if opts.tag:
    opts.tag = "_"+opts.tag

opts.verbose |= opts.Verbose

#-------------------------------------------------

### extract detectors
detectors = [detector_cache.detectors[ifo] for ifo in opts.ifo]
ifos = ','.join(opts.ifo) ### used for FITS headers

#-------------------------------------------------

if opts.verbose:
    print('drawing %d events within [%.6f, %.6f)'%(opts.num_events, gps_start, gps_stop))
template = os.path.join(opts.output_dir, 'sim-skymap-%s%s'%(opts.coord, opts.tag)+'-%dd%09d.fits.gz')
args = gps_start, gps_stop, detectors
kwargs = {
    'size':opts.num_events,
    'nside':opts.nside,
    'time_delay_error':opts.time_delay_error,
}
skymaps = simUtils.simulate_cel_skymaps(*args, **kwargs) if opts.coord=='C' \
    else simUtils.simulate_geo_skymaps(*args, **kwargs)
for time, skymap in skymaps:
    sec = int(time)
    ns = (time-sec)*1e9
    path = template%(sec, ns)
    if opts.Verbose:
        print('    saving: '+path)
    hp.write_map(path, skymap, coord=opts.coord, extra_header=[('GPS', '%.9f'%time), ('IFOS', ifos)])

#!/usr/bin/env python

__usage__ = "condor-compute_network_sensitivity [--options] ifoA pathA1,pathA2,... ifoB pathB1,pathB2,... ..."
__description__ = "massive parallelization of compute_network_sensitivity. We perform the matching association to figure out what IFOs are available when based on the path names"
__author__ = "Reed Essick (reed.essick@ligo.org)"

#-------------------------------------------------

import os

import getpass

from collections import defaultdict

from optparse import OptionParser

#-------------------------------------------------

parser = OptionParser(usage=__usage__, description=__description__)

parser.add_option("-v", "--verbose", default=False, action="store_true")

parser.add_option('', '--universe', default='vanilla', type='string',
    help='DEFAULT=vanilla')
parser.add_option('', '--exe', default='compute_psd', type='string',
    help='specify the explicit path to the executable. \
DEFAULT=compute_psd')

parser.add_option('', '--accounting-group', default='ligo.dev.o1.burst.explore.test', type='string',
    help='DEFAULT=ligo.dev.o1.burst.explore.test')
parser.add_option('', '--accounting-group-user', default=getpass.getuser(), type='string',
    help='DEFAULT='+getpass.getuser())

parser.add_option('', '--retry', default=0, type='int',
    help='DEFAULT=0')

parser.add_option("-o", "--output-dir", default='.', type='string')
parser.add_option("-t", "--tag", default="", type='string')

parser.add_option('-s', '--condor-submit', default=False, action='store_true',
    help='submit the DAG to condor')

opts, args = parser.parse_args()

assert len(args)%2==0, 'please supply an evan number of input arguments\n%s'%__usage__

if opts.tag:
    opts.tag = "_"+opts.tag

if not os.path.exists(opts.output_dir):
    os.makedirs(opts.output_dir)

#--------------------------------------------------

### set up associations with which IFOs are available when
if opts.verbose:
    print( "sorting IFO horizon estiamtes by gps ranges" )
gpstimes = defaultdict( dict )
i = 0
while i < len(args):
    ifo = args[i]
    for path in args[i+1]:
        gpstimes[utils.extract_start_dur(path, suffix='.txt.gz')].update( (ifo, path) )        
    i += 2

#--------------------------------------------------

### write sub file
subname = "%s/compute_network_sensitivity%s.sub"%(opts.output_dir, opts.tag)
if opts.verbose:
    print( "writing : "+subname )
f = open(subname, 'w')
f.write('''universe = %(universe)s
executable = %(exe)s
arguments = "$(gps) $(ifo_horizons) --nside %(nside)d --output-dir %(outdir)s --tag $(tag) -V"
getenv = true
accounting_group = %(accounting_group)s
accounting_group_user = %(accounting_group_user)s
log    = %(outdir)s/condor-compute_network_sensitivity%(tag)s_$(Cluster)-$(Process).log
error  = %(outdir)s/condor-compute_network_sensitivity%(tag)s_$(Cluster)-$(Process).err 
output = %(outdir)s/condor-compute_network_sensitivity%(tag)s_$(Cluster)-$(Process).out
notification = never
queue 1'''%{\
    'universe' : opts.universe,
    'exe' : opts.exe,
    'accounting_group' : opts.accounting_group,
    'accounting_group_user' : opts.accounting_group_user,
    'nside' : opts.nside,
    'outdir' : opts.output_dir,
})
f.close()

### iterate over segments and define compute_psd jobs for each
dagname = subname.replace('.sub', '.dag')
if opts.verbose:
    print( "writing : "+dagname )
f = open(dagname, 'w')

template = '''\
JOB   %(gpsstart)d %(sub)s
VARS  %(gpsstart)d gps="%(gps)d" tag="%(tag)s" ifo_horizons="%(ifo_horizons)s"
RETRY %(gpsstart)d %(retry)d
'''
for (start, dur), ifos in gpstimes.items():
    f.write(template%{\
        'gpsstart' : start,
        'sub' : subname,
        'gps' : start + 0.5*dur, ### take the center of the window, which should be good enough...
        'tag' : opts.tag+'-%d-%d'%(start, dur),
        'ifo_horizons' : '--ifo-horizon '+' --ifo-horizon '.join('%s %s'%tuple(pair) for pair in ifos.items()),
    })
f.close()

#-------------------------------------------------

### submit
if opts.condor_submit:
    if opts.verbose:
        print( 'submitting : '+dagname )
    import subprocess as sp
    sp.Popen(['condor_submit_dag', dagname]).wait()

#!/usr/bin/env python

__usage__ = "sim-exposure [--options] gps_start gps_stop"
__doc__ = """\
a simple script for generating simulated skymaps using quasi-realistic detectors.
NOTE:
    we ignore the relative sensitivity of detectors, which would affect the time-of-arrival via signal bandwidth and snr, etc. This should be corrected in the future."""
__author__ = "reed.essick@ligo.org"

#-------------------------------------------------

import os

import healpy as hp

from optparse import OptionParser

### non-standard libraries
import simUtils
import detector_cache

#-------------------------------------------------

DEFAULT_COORD = 'C'
KNOWN_COORD = ['C', 'E']

#-------------------------------------------------

parser = OptionParser(usage=__usage__, description=__doc__)

parser.add_option('-v', '--verbose', default=False, action='store_true')

parser.add_option('-i', '--ifo', default=[], type='string', action='append',
    help='can be repeated')

parser.add_option('--coord', default=DEFAULT_COORD, type='string',
    help='either E or C. DEFAULT='+DEFAULT_COORD)
parser.add_option('--nside', default=simUtils.DEFAULT_NSIDE, type='int',
    help='DEFAULT=%d'%simUtils.DEFAULT_NSIDE)

parser.add_option('-o', '--output-dir', default='.', type='string')
parser.add_option('-t', '--tag', default='', type='string')

opts, args = parser.parse_args()
assert len(args)==2, 'please supply exactly 2 input arguments\n%s'%__usage__
gps_start, gps_stop = [int(_) for _ in args]
assert opts.coord in KNOWN_COORD, '--coord must be one of: '+','.join(KNOWN_COORD)

if not os.path.exists(opts.output_dir):
    os.makedirs(opts.output_dir)

if opts.tag:
    opts.tag = "_"+opts.tag

#-------------------------------------------------

### extract detectors
detectors = [detector_cache.detectors[ifo] for ifo in opts.ifo]

#-------------------------------------------------

if opts.verbose:
    print('simulating exposure within [%.6f, %.6f)'%(gps_start, gps_stop))
args = gps_start, gps_stop, detectors
kwargs = {
    'nside':opts.nside,
}
head, exposure = simUtils.simulate_cel_exposure(*args, **kwargs) if opts.coord=='C' \
    else simUtils.simulate_geo_exposure(*args, **kwargs)
path = "%s/sim-exposure%s-%d-%d.fits.gz"%(opts.output_dir, opts.tag, gps_start, gps_stop-gps_start)
if opts.verbose:
    print('saving: '+path)
header = [
    ('GPS_START_SEC', head['gps_start_sec']),
    ('GPS_START_NSEC', head['gps_start_nsec']),
    ('GPS_STOP_SEC', head['gps_stop_sec']),
    ('GPS_STOP_NSEC', head['gps_stop_nsec']),
    ('IFOS', ','.join(head['ifos'])),
]
hp.write_map(path, exposure, coord=opts.coord, extra_header=header)
